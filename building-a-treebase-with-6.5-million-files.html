<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="utf-8">
 <title>Building a TreeBase with 6.5 million files</title>
 <script>/* This HTML was generated from building-a-treebase-with-6-point-5-million-files.scroll by ðŸ“œ Scroll v178.1.0. https://scroll.pub */</script>
 <style>@media print {.doNotPrint {display: none !important;}}</style>
 <link rel="canonical" href="https://breckyunits.com/building-a-treebase-with-6.5-million-files.html">
 <meta name="viewport" content="width=device-width,initial-scale=1">
 <meta name="description" content="In this long post Im going to do a stupid thing and see what happens. Specifically Im going to cre">
 <meta name="keywords" content="All, Scroll, Programming, HasDataset">
 <meta name="generator" content="Scroll v178.1.0">
 <meta property="og:title" content="Building a TreeBase with 6.5 million files">
 <meta property="og:description" content="In this long post Im going to do a stupid thing and see what happens. Specifically Im going to cre">
 <meta property="og:image" content="https://breckyunits.com/60files.png">
 
 <link rel="source" type="application/git" title="Source Code Repository" href="edit.html?fileName=/building-a-treebase-with-6-point-5-million-files.scroll">
 <link rel="alternate" type="application/rss+xml" title="Building a TreeBase with 6.5 million files" href="feed.xml">
 <meta name="twitter:card" content="summary_large_image">
</head>
<body>
<link rel="stylesheet" type="text/css" href=".gazette.css">
<link rel="stylesheet" type="text/css" href=".scroll.css">
<style>html, body, h1,h2,h3 { font-family: Helvetica Neue;}</style>
<style>.abstractIconButtonParser {position:absolute;top:0.25rem; }.abstractIconButtonParser svg {fill: rgba(204,204,204,.8);width:1.875rem;height:1.875rem; padding: 0 7px;} .abstractIconButtonParser:hover svg{fill: #333;}</style><a href="index.html" class="doNotPrint abstractIconButtonParser" style="left:2rem;"><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12.7166 3.79541C12.2835 3.49716 11.7165 3.49716 11.2834 3.79541L4.14336 8.7121C3.81027 8.94146 3.60747 9.31108 3.59247 9.70797C3.54064 11.0799 3.4857 13.4824 3.63658 15.1877C3.7504 16.4742 4.05336 18.1747 4.29944 19.4256C4.41371 20.0066 4.91937 20.4284 5.52037 20.4284H8.84433C8.98594 20.4284 9.10074 20.3111 9.10074 20.1665V15.9754C9.10074 14.9627 9.90433 14.1417 10.8956 14.1417H13.4091C14.4004 14.1417 15.204 14.9627 15.204 15.9754V20.1665C15.204 20.3111 15.3188 20.4284 15.4604 20.4284H18.4796C19.0806 20.4284 19.5863 20.0066 19.7006 19.4256C19.9466 18.1747 20.2496 16.4742 20.3634 15.1877C20.5143 13.4824 20.4594 11.0799 20.4075 9.70797C20.3925 9.31108 20.1897 8.94146 19.8566 8.7121L12.7166 3.79541ZM10.4235 2.49217C11.3764 1.83602 12.6236 1.83602 13.5765 2.49217L20.7165 7.40886C21.4457 7.91098 21.9104 8.73651 21.9448 9.64736C21.9966 11.0178 22.0564 13.5119 21.8956 15.3292C21.7738 16.7067 21.4561 18.4786 21.2089 19.7353C20.9461 21.0711 19.7924 22.0001 18.4796 22.0001H15.4604C14.4691 22.0001 13.6655 21.1791 13.6655 20.1665V15.9754C13.6655 15.8307 13.5507 15.7134 13.4091 15.7134H10.8956C10.754 15.7134 10.6392 15.8307 10.6392 15.9754V20.1665C10.6392 21.1791 9.83561 22.0001 8.84433 22.0001H5.52037C4.20761 22.0001 3.05389 21.0711 2.79113 19.7353C2.54392 18.4786 2.22624 16.7067 2.10437 15.3292C1.94358 13.5119 2.00338 11.0178 2.05515 9.64736C2.08957 8.73652 2.55427 7.91098 3.28346 7.40886L10.4235 2.49217Z"/></svg></a>
<style>a.keyboardNav {display:block;position:absolute;top:0.25rem; color: rgba(204,204,204,.8); font-size: 1.875rem; line-height: 1.7rem;}a.keyboardNav:hover{color: #333;text-decoration: none;}</style><a class="keyboardNav doNotPrint" style="left:.5rem;" href="integrity-and-perseverance-in-business-ensure-success.html">&lt;</a><a class="keyboardNav doNotPrint" style="right:.5rem;" href="dataset-needed.html">&gt;</a>
<style>.abstractIconButtonParser {position:absolute;top:0.25rem; }.abstractIconButtonParser svg {fill: rgba(204,204,204,.8);width:1.875rem;height:1.875rem; padding: 0 7px;} .abstractIconButtonParser:hover svg{fill: #333;}</style><a href="edit.html?fileName=/building-a-treebase-with-6-point-5-million-files.scroll" class="doNotPrint abstractIconButtonParser" style="right:2rem;"><svg width="800px" height="800px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M21.1213 2.70705C19.9497 1.53548 18.0503 1.53547 16.8787 2.70705L15.1989 4.38685L7.29289 12.2928C7.16473 12.421 7.07382 12.5816 7.02986 12.7574L6.02986 16.7574C5.94466 17.0982 6.04451 17.4587 6.29289 17.707C6.54127 17.9554 6.90176 18.0553 7.24254 17.9701L11.2425 16.9701C11.4184 16.9261 11.5789 16.8352 11.7071 16.707L19.5556 8.85857L21.2929 7.12126C22.4645 5.94969 22.4645 4.05019 21.2929 2.87862L21.1213 2.70705ZM18.2929 4.12126C18.6834 3.73074 19.3166 3.73074 19.7071 4.12126L19.8787 4.29283C20.2692 4.68336 20.2692 5.31653 19.8787 5.70705L18.8622 6.72357L17.3068 5.10738L18.2929 4.12126ZM15.8923 6.52185L17.4477 8.13804L10.4888 15.097L8.37437 15.6256L8.90296 13.5112L15.8923 6.52185ZM4 7.99994C4 7.44766 4.44772 6.99994 5 6.99994H10C10.5523 6.99994 11 6.55223 11 5.99994C11 5.44766 10.5523 4.99994 10 4.99994H5C3.34315 4.99994 2 6.34309 2 7.99994V18.9999C2 20.6568 3.34315 21.9999 5 21.9999H16C17.6569 21.9999 19 20.6568 19 18.9999V13.9999C19 13.4477 18.5523 12.9999 18 12.9999C17.4477 12.9999 17 13.4477 17 13.9999V18.9999C17 19.5522 16.5523 19.9999 16 19.9999H5C4.44772 19.9999 4 19.5522 4 18.9999V7.99994Z"/></svg></a>
<style>img {border: 2px solid #e9e9e9; border-radius: 5px;}</style>
<div id="particle37" class="scrollContainerParser" style="width: 100%; box-sizing: border-box; max-width: 500px; margin: 0 auto;">
<div class="scrollSection"><h1 id="particle38" class="printTitleParser"><a href="building-a-treebase-with-6.5-million-files.html">Building a TreeBase with 6.5 million files</a></h1>
</div>
<p id="particle41" class="scrollParagraph"><span class="scrollDateline">January 29, 2020 â€” </span>In this long post I'm going to do a stupid thing and see what happens. Specifically I'm going to create 6.5 million files in a single folder and try to use Git and Sublime and other tools with that folder. All to explore this new thing I'm working on.</p>
<p id="particle43" class="scrollParagraph"><a href="https://truebase.pub">TreeBase</a> is a new system I am working on for long-term, strongly-typed collaborative knowledge bases. The design of TreeBase is dumb. It's just a folder with a bunch of files encoded with <a href="https://treenotation.org">Tree Notation</a>. A row in a normal SQL table in TreeBase is roughly equivalent to a file. The filenames serve as IDs. Instead of each using an optimized binary storage format it just uses plain text like UTF-8. Field names are stored alongside the values in every file. Instead of starting with a schema you can just start adding files and evolve your schema and types as you go.</p>
<p id="particle47" class="scrollParagraph">For example, in this tiny demo <a href="https://github.com/breck7/truebase/tree/main/planetsDB">TreeBase of the planets</a> the file <code class="scrollInlineCode">mars.planet</code> looks like this:</p>
<code class="scrollCodeBlock">diameter 6794
surfaceGravity 4
yearsToOrbitSun 1.881
moons 2</code>
<p id="particle51" class="scrollParagraph">TreeBase is composed of 3 key ingredients.</p>
<p id="particle53" class="scrollParagraph"><strong>Ingredient 1: A folder</strong> All that TreeBase requires is a file system (although in theory you could build an analog TreeBase on paper). This means that you can use any tools on your system for editing files for editing your database.</p>
<p id="particle55" class="scrollParagraph"><strong>Ingredient 2: Git</strong> Instead of having code to implement any sort of versioning or metadata tracking, you just use Git. Edit your files and use Git for history, branching, collaboration, etc. Because Tree Notation is a line and word based syntax it meshes really well with Git workflows.</p>
<p id="particle57" class="scrollParagraph"><strong>Ingredient 3: <a href="https://treenotation.org">Tree Notation</a></strong> The Third Ingredient for making a TreeBase is Tree Notation. Both schemas and data use Tree Notation. This is a new very simple syntax for encoding strongly typed data. It's simple, extensible, and plays well with Git.</p>
<div class="scrollSection"><h1 id="particle59" class="scrollParagraph">TreeBase Compared to Other Database Systems</h1>
</div>
<p id="particle61" class="scrollParagraph">Probably hundreds of billions of dollars has gone into designing robust database systems like <a href="https://www.microsoft.com/en-us/sql-server/default.aspx">SQL Server</a>, <a href="https://en.wikipedia.org/wiki/Oracle_Database">Oracle</a>, <a href="https://www.postgresql.org">PostgreSQL</a>, <a href="https://www.mysql.com">MySQL</a>, <a href="https://www.mongodb.com">MongoDB</a>, <a href="https://www.sqlite.org">SQLite</a> and so forth. These things run the world. They are incredibly robust and battle-hardened. Everything that can happen is thought of and planned for, and everything that can go wrong has gone wrong (and learned from). These databases can handle trillions of rows, can conduct complex real-time transactions, and survive disasters of all sort. They use sophisticated binary formats and are tuned for specific file systems. Thousands of people have gotten their PhD's working on database technology.</p>
<p id="particle63" class="scrollParagraph">TreeBase doesn't have any of that. TreeBase is stupid. It's just a bunch of files in a folder.</p>
<p id="particle65" class="scrollParagraph">You might be asking yourself "Why use TreeBase at all when great databases exist?". To further put the stupidity of the current TreeBase design into perspective, the <a href="https://devblogs.microsoft.com/bharry/the-largest-git-repo-on-the-planet/">Largest Git Repo on the Planet is Windows</a> which has 3.5 million files. I'm going to try and create a repo with 6.5 million files on my laptop.</p>
<p id="particle67" class="scrollParagraph">Even if you think TreeBase is silly aren't you curious what happens when I try to put 6.5 million files into one folder? I kind of am. If you want an explanation of <em>why</em> TreeBase, I'll get to that near the end of this post.</p>
<p id="particle69" class="scrollParagraph">But first...</p>
<div class="scrollSection"><h1 id="particle71" class="scrollParagraph">Let's Break TreeBase</h1>
</div>
<p id="particle73" class="scrollParagraph">Here again is a <a href="https://github.com/breck7/truebase/tree/main/planetsDB">demo TreeBase</a> with only 8 files.</p>
<p id="particle75" class="scrollParagraph">The biggest TreeBase I work with has on the order of 10,000 files. Some files have thousands of lines, some just a handful.</p>
<p id="particle77" class="scrollParagraph">While TreeBase has been great at this small scale, a question I've been asked, and have wondered myself, is what happens when a TreeBase gets too big?</p>
<p id="particle79" class="scrollParagraph">I'm about to find out, and I'll document the whole thing.</p>
<p id="particle81" class="scrollParagraph">Every time something bad happens I'll include a ðŸ’£.</p>
<div class="scrollSection"><h1 id="particle83" class="scrollParagraph">Choosing a Topic</h1>
</div>
<p id="particle85" class="scrollParagraph">TreeBase is meant for knowledge bases. So all TreeBases center around a topic.</p>
<p id="particle87" class="scrollParagraph">To test TreeBase on a big scale I want something realistic. I wanted to choose some big structured database that thousands of people have contributed to that's been around for a while and see what it would look like as a TreeBase.</p>
<p id="particle89" class="scrollParagraph">IMDB is just such a database and amazingly makes a lot of their data available for <a href="https://www.imdb.com/interfaces/">download</a>. So movies will be the topic and the IMDB dataset will be my test case.</p>
<div class="scrollSection"><h1 id="particle91" class="scrollParagraph">The Dataset</h1>
</div>
<p id="particle93" class="scrollParagraph">First I grabbed the data. I downloaded the 7 files from IMDB to my laptop. After unzipping, they were about 7GB.</p>
<p id="particle95" class="scrollParagraph">One file, the 500MB <code class="scrollInlineCode">title.basics.tsv</code>, contained basic data for all the movie and shows in the database.</p>
<p id="particle97" class="scrollParagraph">Here's what that file looks like with <code class="scrollInlineCode">head -5 title.basics.tsv</code>:</p>
<table id="table61" class="scrollTable">
 <thead><tr><th>tconst</th>

<th>titleType</th>

<th>primaryTitle</th>

<th>originalTitle</th>

<th>isAdult</th>

<th>startYear</th>

<th>endYear</th>

<th>runtimeMinutes</th>

<th>genres</th>
</tr></thead>
 <tbody><tr><td>tt0000001</td>
<td>short</td>
<td>Carmencita</td>
<td>Carmencita</td>
<td>0</td>
<td>1894</td>
<td>\N</td>
<td>1</td>
<td>Documentary,Short</td>
</tr>
<tr><td>tt0000002</td>
<td>short</td>
<td>Le clown et ses chiens</td>
<td>Le clown et ses chiens</td>
<td>0</td>
<td>1892</td>
<td>\N</td>
<td>5</td>
<td>Animation,Short</td>
</tr>
<tr><td>tt0000003</td>
<td>short</td>
<td>Pauvre Pierrot</td>
<td>Pauvre Pierrot</td>
<td>0</td>
<td>1892</td>
<td>\N</td>
<td>4</td>
<td>Animation,Comedy,Romance</td>
</tr>
<tr><td>tt0000004</td>
<td>short</td>
<td>Un bon bock</td>
<td>Un bon bock</td>
<td>0</td>
<td>1892</td>
<td>\N</td>
<td>\N</td>
<td>Animation,Short</td>
</tr></tbody>
 </table>
<p id="particle101" class="scrollParagraph">This looks like a good candidate for TreeBase. With this TSV I can create a file for each movie. I don't need the other 6 files for this experiment, though if this was a real project I'd like to merge in that data as well (in that case I'd probably create a second TreeBase for the <code class="scrollInlineCode">names</code> in the IMDB dataset).</p>
<p id="particle103" class="scrollParagraph">Doing a simple line count <code class="scrollInlineCode">wc -l title.basics.tsv</code> I learn that there are around 6.5M titles in <code class="scrollInlineCode">title.basics.tsv</code>. With the current implementation of TreeBase this would be 6.5M files in 1 folder. That should handily break things.</p>
<p id="particle105" class="scrollParagraph">The TreeBase design calls for me to create 1 file for every row in that TSV file. To again stress how dumb this design is keep in mind a 500MB TSV with 6.5M rows can be parsed and analyzed with tools like R or Python in seconds. You could even load the thing near instantly into a SQLite database and utilize any SQL tool to explore the dataset. Instead I am about to spend hours, perhaps days, turning it into a TreeBase.</p>
<div class="scrollSection"><h1 id="particle107" class="scrollParagraph">From 1 File to 6.5 Million Files</h1>
</div>
<p id="particle109" class="scrollParagraph">What will happen when I split 1 file into 6.5 million files? Well, it's clear I am going to waste some space.</p>
<p id="particle111" class="scrollParagraph">A file doesn't just take up space for its contents: it also has metadata. Every file contains metadata like permissions, modification time, etc. That metadata must take up some space, right? If I were to create 6.5M new files, how much extra space would that take up?</p>
<p id="particle113" class="scrollParagraph">My MacBook uses <a href="https://en.wikipedia.org/wiki/Apple_File_System">APFS</a> It can hold up to 9,000,000,000,000,000,000 files. I can't easily find hard numbers on how much metadata one file takes up but can at least start with a ballpark estimate.</p>
<p id="particle115" class="scrollParagraph">I'll start by considering the space filenames will take up.</p>
<p id="particle117" class="scrollParagraph">In TreeBase filenames are composed of a permalink and a file extension. The file extension is to make it easier for editors to understand the schema of a file. In the planets TreeBase above, the files all had the <code class="scrollInlineCode">planet</code> extension and there is a <code class="scrollInlineCode">planet.grammar</code> file that contains information for the tools like syntax highlighters and type checkers. For my new IMDB TreeBase there will be a similar <code class="scrollInlineCode">title.grammar</code> file and each file will have the ".title" extension. So that is 6 bytes per file. Or merely 36MB extra for the file extensions.</p>
<p id="particle119" class="scrollParagraph">Next, the body of each filename will be a readable ID. TreeBase has meaningful filenames to work well with Git and existing file tools. It keeps things simple. For this TreeBase, I will make the ID from the primaryTitle column in the dataset. Let's see how much space that will take.</p>
<p id="particle121" class="scrollParagraph">I'll try <code class="scrollInlineCode">xsv select primaryTitle title.basics.tsv | wc</code>.</p>
<p id="particle123" class="scrollParagraph">ðŸ’£ I got this error:</p>
<code class="scrollCodeBlock">CSV error: record 1102213 (line: 1102214, byte: 91470022): found record with 8 fields, but the previous record has 9 fields
 1102213 3564906 21815916</code>
<p id="particle127" class="scrollParagraph"><a href="https://github.com/BurntSushi/xsv">XSV</a> didn't like something in that file. Instead of getting bogged down, I'll just work around it.</p>
<p id="particle129" class="scrollParagraph">I'll build a subset from the first 1M rows with <code class="scrollInlineCode">head -n 1000000 title.basics.tsv > 1m.title.basics.tsv</code>. Now I will compute against that subset with <code class="scrollInlineCode">xsv select primaryTitle 1m.title.basics.tsv | wc</code>. I get <code class="scrollInlineCode">19751733</code> so an average of 20 characters per title.</p>
<p id="particle131" class="scrollParagraph">I'll combine that with the space for file extension and round that to say 30 extra bytes of file information for each of the 6.5 million titles. <strong>So about 200MB of extra data required to split this 500MB file into filenames. Even though that's a 50% increase, 200MB is dirt cheap so that doesn't seem so bad.</strong></p>
<p id="particle133" class="scrollParagraph">You may think that I could save a roughly equivalent amount by dropping the primaryTitle field. However, even though my filenames now contain information from the title, my permalink schema will generally distort the title so I need to preserve it in each file and won't get savings there. I use a more restrictive character set in the permalink schema than the file contents just to make things like URLs easier.</p>
<p id="particle135" class="scrollParagraph">Again you might ask why not just an integer for the permalink? You could but that's not the TreeBase way. The human readable permalinks play nice with tools like text editors, URLs, and Git. TreeBase is about leveraging software that already works well with file systems. If you use meaningless IDs for filenames you do away with one of the very useful features of the TreeBase system.</p>
<p id="particle137" class="scrollParagraph">But I won't just waste space in metadata. I'm also going to add duplicate data to the contents of each file. That's because I won't be storing just values like <code class="scrollInlineCode">1999</code> but I'll also be repeating column names in each file like <code class="scrollInlineCode">startYear 1999</code>.</p>
<p id="particle139" class="scrollParagraph">How much space will this take up? The titles file has 9 columns and using <code class="scrollInlineCode">head -n 1 1m.title.basics.tsv | wc</code> I see that adds up to 92 bytes. I'll round that up to 100, and multiple by 6.5M, and that adds up to about 65,000,000 duplicate words and 650MB. In other words the space requirements roughly doubled (of course, assuming no compression by the file system under the hood).</p>
<p id="particle141" class="scrollParagraph">You might be wondering why not just drop the column names from each file? Again, it's just not the TreeBase way. By including the column names, each file is self-documenting. I can open up any file with a text editor and easily change it.</p>
<p id="particle143" class="scrollParagraph"><strong>So to recap: splitting this 1 TSV file into 6.5 million files is going to take up 2-3x more space due to metadata and repetition of column names.</strong></p>
<p id="particle145" class="scrollParagraph">Because this is text data, that's actually not so bad. I don't foresee problems arising from wasted disk space.</p>
<div class="scrollSection"><h1 id="particle147" class="scrollParagraph">Foreseeing Speed Problems</h1>
</div>
<p id="particle149" class="scrollParagraph">Before I get to the fun part, I'm going to stop for a second and try and predict what the problems are going to be.</p>
<p id="particle151" class="scrollParagraph">Again, in this experiment I'm going to build and attempt to work with a TreeBase roughly 1,000 times larger than any I've worked with before. A 3 order of magnitude jump.</p>
<p id="particle153" class="scrollParagraph">Disk space won't be a problem. But are the software tools I work with on a day-to-day basis designed to handle millions of files in a single folder? How will they hold up?</p>
<ul ><li id="particle155" ><strong>Bash</strong> How will the basics like <code class="scrollInlineCode">ls</code> and <code class="scrollInlineCode">grep</code> hold up in a folder with 6.5M files?</li>
<li id="particle156" ><strong>Git</strong> How slow will <code class="scrollInlineCode">git status</code> be? What about <code class="scrollInlineCode">git add</code> and <code class="scrollInlineCode">git commit</code>?</li>
<li id="particle157" ><strong>Sublime Text</strong> Will I even be able to open this folder in Sublime Text? Find/replace is something I so commonly use, will that work?  How about regex find/replace?</li>
<li id="particle158" ><strong>Finder</strong> Will I be able to visually browse around?</li>
<li id="particle159" ><strong>TreeBase Scripts</strong> Will my simple TreeBase scripts be usable? Will I be able to type check a TreeBase?</li>
<li id="particle160" ><strong>GitHub</strong> Will GitHub be able to handle 6.5M files?</li></ul>
<div class="scrollSection"><h1 id="particle162" class="scrollParagraph">Proceeding in Stages</h1>
</div>
<p id="particle164" class="scrollParagraph">Since I am going to make a 3 order of magnitude jump, I figured it would be best to make those jumps one at a time.</p>
<p id="particle166" class="scrollParagraph">Actually, to be smart, I will create 5 TreeBases and make 4 jumps. I'll make 1 small TreeBase for sanity checks and then four where I increase by 10x 3 times and see how things hold up.</p>
<p id="particle168" class="scrollParagraph">First, I'll create 5 folders: <code class="scrollInlineCode">mkdir 60; mkdir 6k; mkdir 60k; mkdir 600k; mkdir 6m</code></p>
<p id="particle170" class="scrollParagraph">Now I'll create 4 smaller subsets for the smaller bases. For the final 6.5M base I'll just use the original file.</p>
<code class="scrollCodeBlock">head -n 60 title.basics.tsv > 60/titles.tsv
head -n 6000 title.basics.tsv > 6k/titles.tsv
head -n 60000 title.basics.tsv > 60k/titles.tsv
head -n 600000 title.basics.tsv > 600k/titles.tsv</code>
<p id="particle174" class="scrollParagraph">Now I'll write a script to turn those TSV rows into TreeBase files.</p>
<code class="scrollCodeBlock">#! /usr/local/bin/node --use_strict
const { jtree } = require("jtree")
const { Disk } = require("jtree/products/Disk.node.js")
const folder = "600k"
const path = `${__dirname}/../imdb/${folder}.titles.tsv`
const tree = jtree.TreeNode.fromTsv(Disk.read(path).trim())
const permalinkSet = new Set()
tree.forEach(node => {
  let permalink = jtree.Utils.stringToPermalink(node.get("primaryTitle"))
  let counter = ""
  let dash = ""
  while (permalinkSet.has(permalink + dash + counter)) {
    dash = "-"
    counter = counter ? counter + 1 : 2
  }
  const finalPermalink = permalink + dash + counter
  permalinkSet.add(finalPermalink)
  // Delete Null values:
  node.forEach(field => {
    if (field.getContent() === "\\N") field.destroy()
  })
  if (node.get("originalTitle") === node.get("primaryTitle")) node.getNode("originalTitle").destroy()
  Disk.write(`${__dirname}/../imdb/${folder}/${finalPermalink}.title`, node.childrenToString())
})</code>
<p id="particle178" class="scrollParagraph">The script iterates over each node and creates a file for each row in the TSV.</p>
<p id="particle180" class="scrollParagraph">This script required a few design decisions. For permalink uniqueness, I simply keep a set of titles and number them if a name comes up multiple times. There's also the question of what to do with nulls. IMDB sets the value to <code class="scrollInlineCode">\N</code>. Generally the TreeBase way is to not include the field in question. So I filtered out null values. For cases where <code class="scrollInlineCode">primaryTitle === originalTitle</code>, I stripped the latter. For the Genres field, it's a CSV array. I'd like to make that follow the TreeBase convention of a SSV. I don't know all the possibilities though without iterating, so I'll just skip this for now.</p>
<p id="particle182" class="scrollParagraph">Here are the results of the script for the small 60 file TreeBase:</p>
<figure class="scrollCaptionedFigure" style="width:492px; margin: auto;"><a href="60files.png" target="_blank"  ><img src="60files.png" width="492" height="560" loading="lazy"></a></figure>
<div class="scrollSection"><h1 id="particle186" class="scrollParagraph">Building the Grammar File</h1>
</div>
<p id="particle188" class="scrollParagraph">The Grammar file adds some intelligence to a TreeBase. You can think of it as the schema for your base. TreeBase scripts can read those Grammar files and then do things like provide type checking or syntax highlighting.</p>
<p id="particle190" class="scrollParagraph">Now that we have a sample <code class="scrollInlineCode">title</code> file, I'm going to take a first pass at the grammar file for our TreeBase. I copied the file <code class="scrollInlineCode">the-photographical-congress-arrives-in-lyon.title</code> and pasted it into the right side of the <a href="https://jtree.treenotation.org/designer/">Tree Language Designer</a>. Then I clicked <code class="scrollInlineCode">Infer Prefix Grammar</code>.</p>
<p id="particle192" class="scrollParagraph">That gave me a decent starting point for the grammar:</p>
<code class="scrollCodeBlock">inferredLanguageNode
 root
 inScope tconstNode titleTypeNode primaryTitleNode originalTitleNode isAdultNode startYearNode runtimeMinutesNode genresNode
keywordCell
anyCell
bitCell
intCell
tconstNode
 crux tconst
 cells keywordCell anyCell
titleTypeNode
 crux titleType
 cells keywordCell anyCell
primaryTitleNode
 crux primaryTitle
 cells keywordCell anyCell anyCell anyCell anyCell anyCell anyCell
originalTitleNode
 crux originalTitle
 cells keywordCell anyCell anyCell anyCell anyCell anyCell anyCell anyCell anyCell
isAdultNode
 crux isAdult
 cells keywordCell bitCell
startYearNode
 crux startYear
 cells keywordCell intCell
runtimeMinutesNode
 crux runtimeMinutes
 cells keywordCell bitCell
genresNode
 crux genres
 cells keywordCell anyCell</code>
<p id="particle196" class="scrollParagraph">The generated grammar needed a little work. I renamed the root node and added catchAlls and a base "abstractFactType". The Grammar language and tooling for TreeBase is very new, so all that should improve as time goes on.</p>
<p id="particle198" class="scrollParagraph">My <code class="scrollInlineCode">title.grammar</code> file now looks like this:</p>
<code class="scrollCodeBlock">titleNode
 root
 pattern \.title$
 inScope abstractFactNode
keywordCell
anyCell
bitCell
intCell
abstractFactNode
 abstract
 cells keywordCell anyCell
tconstNode
 crux tconst
 extends abstractFactNode
titleTypeNode
 crux titleType
 extends abstractFactNode
primaryTitleNode
 crux primaryTitle
 extends abstractFactNode
 catchAllCellType anyCell
originalTitleNode
 crux originalTitle
 extends abstractFactNode
 catchAllCellType anyCell
isAdultNode
 crux isAdult
 cells keywordCell bitCell
 extends abstractFactNode
startYearNode
 crux startYear
 cells keywordCell intCell
 extends abstractFactNode
runtimeMinutesNode
 crux runtimeMinutes
 cells keywordCell intCell
 extends abstractFactNode
genresNode
 crux genres
 cells keywordCell anyCell
 extends abstractFactNode</code>
<p id="particle202" class="scrollParagraph">Next I coped that file into the <code class="scrollInlineCode">60</code> folder with <code class="scrollInlineCode">cp /Users/breck/imdb/title.grammar 60/</code>. I have the <code class="scrollInlineCode">jtree</code> package installed on my local machine so I registered this new language with that with the command <code class="scrollInlineCode">jtree register /Users/breck/imdb/title.grammar</code>. Finally, I generated a Sublime syntax file for these title files with <code class="scrollInlineCode">jtree sublime title #pathToMySublimePluginDir</code>.</p>
<p id="particle204" class="scrollParagraph">Now I have rudimentary syntax highlighting for these new title files:</p>
<figure class="scrollCaptionedFigure" style="width:425px; margin: auto;"><a href="sublimeText.png" target="_blank"  ><img src="sublimeText.png" width="425" height="253" loading="lazy"></a></figure>
<p id="particle208" class="scrollParagraph">Notice the syntax highlighting is a little broken. The Sublime syntax generating <a href="https://github.com/treenotation/jtree/issues/8">still needs some work</a>.</p>
<p id="particle210" class="scrollParagraph">Anyway, now we've got the basics done. We have a script for turning our CSV rows into Tree Notation files and we have a basic schema/grammar for our new TreeBase.</p>
<p id="particle212" class="scrollParagraph">Let's get started with the bigger tests now.</p>
<div class="scrollSection"><h1 id="particle214" class="scrollParagraph">A 6k TreeBase</h1>
</div>
<p id="particle216" class="scrollParagraph">I'm expecting this to be an easy one. I update my script to target the 6k files and run it with <code class="scrollInlineCode">/Users/breck/imdb/build.js</code>. A little alarmingly, it takes a couple of seconds to run:</p>
<code class="scrollCodeBlock">real  0m3.144s
user  0m1.203s
sys 0m1.646s</code>
<p id="particle220" class="scrollParagraph">The main script is going to iterate over 1,000x as many items so if this rate holds up it would take 50 minutes to generate the 6M TreeBase!</p>
<p id="particle222" class="scrollParagraph">I do have some optimization ideas in mind, but for now let's explore the results.</p>
<p id="particle224" class="scrollParagraph">First, let me build a catalog of typical tasks that I do with TreeBase that I will try to repeat with the 6k, 60k, 600k, and 6.5M TreeBases.</p>
<p id="particle226" class="scrollParagraph">I'll just list them in Tree Notation:</p>
<code class="scrollCodeBlock">task ls
 category bash
 description
task open sublime
 category sublime
 description Start sublime in the TreeBase folder
task sublime responsiveness
 category sublime
 description scroll and click around files in the treebase folder and see how responsive it feels.
task sublime search
 category sublime
 description find all movies with the query "titleType movie"
task sublime regex search
 category sublime
 description find all comedy movies with the regex query "genres ._Comedy._"
task open finder
 category finder
 description open the folder in finder and browse around
task git init
 category git
 description init git for the treebase
task git first status
 category git
 description see git status
task git first add
 category git
 description first git add for the treebase
task git first commit
 category git
 description first git commit
task sublime editing
 category sublime
 description edit some file
task git status
 category git
 description git status when there is a change
task git add
 category git
 description add the change above
task git commit
 category git
 description commit the change
task github push
 category github
 description push the treebase to github
task treebase start
 category treebase
 description how long will it take to start treebase
task treebase error check
 category treebase
 description how long will it take to scan the base for errors.</code>
<p id="particle230" class="scrollParagraph">ðŸ’£ Before I get to the results, let me note I had 2 bugs. First I needed to update my <code class="scrollInlineCode">title.grammar</code> file by adding a <code class="scrollInlineCode">cells fileNameCell</code> to the root node and also adding a <code class="scrollInlineCode">fileNameCell</code> line. Second, my strategy above of putting the CSV file for each TreeBase into the same folder as the TreeBase was not ideal as Sublime Text would open that file as well. So I moved each file up with <code class="scrollInlineCode">mv titles.tsv ../6k.titles.tsv</code>.</p>
<p id="particle232" class="scrollParagraph">The results for 6k are below.</p>
<table id="table62" class="scrollTable">
 <thead><tr><th>category</th>

<th>description</th>

<th>result</th>
</tr></thead>
 <tbody><tr><td>bash</td>
<td>ls</td>
<td>instant</td>
</tr>
<tr><td>sublime</td>
<td>Start sublime in the TreeBase folder</td>
<td>instant</td>
</tr>
<tr><td>sublime</td>
<td>scroll and click around files in the treebase folder and see how responsive it feels.</td>
<td>nearInstant</td>
</tr>
<tr><td>sublime</td>
<td>find all movies with the query "titleType movie"</td>
<td>neaerInstant</td>
</tr>
<tr><td>sublime</td>
<td>find all comedy movies with the regex query "genres ._Comedy._"</td>
<td>nearInstant</td>
</tr>
<tr><td>finder</td>
<td>open and browse</td>
<td>instant</td>
</tr>
<tr><td>git</td>
<td>init git for the treebase</td>
<td>instant</td>
</tr>
<tr><td>git</td>
<td>see git status</td>
<td>instant</td>
</tr>
<tr><td>git</td>
<td>first git add for the treebase</td>
<td>aFewSeconds</td>
</tr>
<tr><td>git</td>
<td>first git commit</td>
<td>instant</td>
</tr>
<tr><td>sublime</td>
<td>edit some file</td>
<td>instant</td>
</tr>
<tr><td>git</td>
<td>git status when there is a change</td>
<td>instant</td>
</tr>
<tr><td>git</td>
<td>add the change above</td>
<td>instant</td>
</tr>
<tr><td>git</td>
<td>commit the change</td>
<td>instant</td>
</tr>
<tr><td>github</td>
<td>push the treebase to github</td>
<td>~10 seconds</td>
</tr>
<tr><td>treebase</td>
<td>how long will it take to start treebase</td>
<td>instant</td>
</tr>
<tr><td>treebase</td>
<td>how long will it take to scan the base for errors.</td>
<td>nearInstant</td>
</tr></tbody>
 </table>
<p id="particle236" class="scrollParagraph">So 6k worked without a hitch. Not surprising as this is in the ballpark of where I normally operate with TreeBases.</p>
<p id="particle238" class="scrollParagraph">Now for the first of three 10x jumps.</p>
<div class="scrollSection"><h1 id="particle240" class="scrollParagraph">A 60k TreeBase</h1>
</div>
<p id="particle242" class="scrollParagraph">ðŸ’£ This markdown file that I'm writing was in the parent folder of the 60k directory and Sublime text seemed to be slowing a bit, so I closed Sublime and created a new unrelated folder to hold this writeup separate from the TreeBase folders.</p>
<p id="particle244" class="scrollParagraph">The build script for the 60k TreeBase took 30 seconds or so, as expected. I can optimize for that later.</p>
<p id="particle246" class="scrollParagraph">I now repeat the tasks from above to see how things are holding up.</p>
<table id="table63" class="scrollTable">
 <thead><tr><th>category</th>

<th>description</th>

<th>result</th>
</tr></thead>
 <tbody><tr><td>bash</td>
<td>ls</td>
<td>aFewSeconds</td>
</tr>
<tr><td>sublime</td>
<td>Start sublime in the TreeBase folder</td>
<td>aFewSeconds with Beachball</td>
</tr>
<tr><td>sublime</td>
<td>scroll and click around files in the treebase folder and see how responsive it feels.</td>
<td>instant</td>
</tr>
<tr><td>sublime</td>
<td>find all movies with the query "titleType movie"</td>
<td>~20 seconds with beachball</td>
</tr>
<tr><td>sublime</td>
<td>find all comedy movies with the regex query "genres ._Comedy._"</td>
<td>~20 seconds with beachball</td>
</tr>
<tr><td>git</td>
<td>init git for the treebase</td>
<td>instant</td>
</tr>
<tr><td>finder</td>
<td>open and browse</td>
<td>6 seconds</td>
</tr>
<tr><td>git</td>
<td>see git status</td>
<td>nearInstant</td>
</tr>
<tr><td>git</td>
<td>first git add for the treebase</td>
<td>1 minute</td>
</tr>
<tr><td>git</td>
<td>first git commit</td>
<td>10 seconds</td>
</tr>
<tr><td>sublime</td>
<td>edit some file</td>
<td>instant</td>
</tr>
<tr><td>git</td>
<td>git status when there is a change</td>
<td>instant</td>
</tr>
<tr><td>git</td>
<td>add the change above</td>
<td>instant</td>
</tr>
<tr><td>git</td>
<td>commit the change</td>
<td>instant</td>
</tr>
<tr><td>github</td>
<td>push the treebase to github</td>
<td>~10 seconds</td>
</tr>
<tr><td>treebase</td>
<td>how long will it take to start treebase</td>
<td>~10 seconds</td>
</tr>
<tr><td>treebase</td>
<td>how long will it take to scan the base for errors.</td>
<td>~5 seconds</td>
</tr></tbody>
 </table>
<p id="particle250" class="scrollParagraph">Uh oh. Already I am noticing some scaling delays with a few of these tasks.</p>
<p id="particle252" class="scrollParagraph">ðŸ’£ The first <code class="scrollInlineCode">git add</code> took about 1 minute. I used to know the internals of Git well but that was a decade ago and my knowledge is rusty.</p>
<p id="particle254" class="scrollParagraph">I will now look some stuff up. Could Git be creating 1 file for each file in my TreeBase? I found <a href="https://www.monperrus.net/martin/one-million-files-on-git-and-github">this post</a> from someone who created a Git repo with 1.7M files which should turn out to contain useful information. From that post it looks like you can indeed expect 1 file for Git for each file in the project.</p>
<p id="particle256" class="scrollParagraph">The first <code class="scrollInlineCode">git commit</code> took about 10 seconds. Why? Git printed a message about <a href="https://stackoverflow.com/questions/8633981/what-does-auto-packing-the-repository-for-optimum-performance-mean/16233094">Autopacking</a>. It seems Git will combine a lot of small files into packs (perhaps in bundles of 6,700, though I haven't dug in to this) to speed things up. Makes sense.</p>
<p id="particle258" class="scrollParagraph">ðŸ’£ I forgot to mention, while doing the tasks for the 60k TreeBase, my computer fan kicked on. A brief look at Activity Monitor showed a number of <code class="scrollInlineCode">mdworker_shared</code> processes using single digit CPU percentages each, which appears to be some <a href="https://discussions.apple.com/thread/8510132">OS level indexing process</a>. That's hinting that a bigger TreeBase might require at least some basic OS/file system config'ing.</p>
<p id="particle260" class="scrollParagraph">Besides the delays with <code class="scrollInlineCode">git</code> everything else seemed to remain fast. The 60k TreeBase choked a little more than I'd like but seems with a few tweaks things could remain screaming fast.</p>
<p id="particle262" class="scrollParagraph">Let's move on to the first real challenge.</p>
<div class="scrollSection"><h1 id="particle264" class="scrollParagraph">A 600k TreeBase</h1>
</div>
<p id="particle266" class="scrollParagraph">ðŸ’£ The first problem I hit immediately in that my <code class="scrollInlineCode">build.js</code> is not efficient. I hit a v8 out of memory error. I could solve this by either 1) streaming the TSV one row at a time or 2) cleaning up the unoptimized jtree library to handle bigger data better. I chose to spend a few minutes and go with option 1).</p>
<p id="particle268" class="scrollParagraph">ðŸ’£ It appears the first build script started writing files to the 600k directory before it failed. I had to <code class="scrollInlineCode">rm -rf 600k/</code> and that took a surprisingly long time. Probably a minute or so. Something to keep an eye on.</p>
<p id="particle270" class="scrollParagraph">ðŸ’£  I updated my build script to use streams. Unfortunately the streaming <a href="https://www.npmjs.com/package/csv-parse">csv parser</a> I switched to choked on line 32546. Inspecting that vicinity it was hard to detect what it was breaking on. Before diving in I figured I'd try a <a href="https://www.npmjs.com/package/csv-parser">different library</a>.</p>
<p id="particle272" class="scrollParagraph">ðŸ’£ The new library seemed to be working but it was taking a while so I added some instrumentation to the script. From those logs the new script seems to generate about 1.5k files per second. So should take about 6 minutes for all 600k. For the 6.5M files, that would grow to an hour, so perhaps there's more optimization work to be done here.</p>
<p id="particle274" class="scrollParagraph">ðŸ’£ Unfortunately the script exited early with:</p>
<code class="scrollCodeBlock">Error: ENAMETOOLONG: name too long, open '/Users/breck/imdbPost/../imdb/600k/mord-an-lottomillionr-karl-hinrich-charly-l.sexualdelikt-an-carola-b.bankangestellter-zweimal-vom-selben-bankruber-berfallenmord-an-lottomillionr-karl-hinrich-charly-l.sexualdelikt-an-carola-b.bankangestellter-zweimal-vom-selben-bankruber-berfallen01985nncrimenews.title'</code>
<p id="particle278" class="scrollParagraph">Turns out the Apple File System has a filename <a href="https://en.wikipedia.org/wiki/Comparison_of_file_systems">size limit</a> of 255 UTF-8 characters so this error is understandable. However, inspecting the filename shows that for some reason the permalink was generated by combining the original title with the primary title. Sounds like a bug.</p>
<p id="particle280" class="scrollParagraph">I <code class="scrollInlineCode">cd</code> into the <code class="scrollInlineCode">600k</code> directory to see what's going on.</p>
<p id="particle282" class="scrollParagraph">ðŸ’£ Unfortunately <code class="scrollInlineCode">ls</code> hangs. <code class="scrollInlineCode">ls -f -1 -U</code> seems to go faster.</p>
<p id="particle284" class="scrollParagraph">The titles look correct. I'm not sure why the script got hung up on that one entry. For now I'll just wrap the function call in a Try/Catch and press on. I should probably make this script resumable but will skip that for now.</p>
<p id="particle286" class="scrollParagraph">Rerunning the script...it worked! That line seemed to be the only problematic line.</p>
<p id="particle288" class="scrollParagraph">We now have our 600k TreeBase.</p>
<table id="table64" class="scrollTable">
 <thead><tr><th>category</th>

<th>description</th>

<th>result</th>
</tr></thead>
 <tbody><tr><td>bash</td>
<td>ls</td>
<td>~30 seconds</td>
</tr>
<tr><td>sublime</td>
<td>Start sublime in the TreeBase folder</td>
<td>failed</td>
</tr>
<tr><td>sublime</td>
<td>scroll and click around files in the treebase folder and see how responsive it feels.</td>
<td>X</td>
</tr>
<tr><td>sublime</td>
<td>find all movies with the query "titleType movie"</td>
<td>X</td>
</tr>
<tr><td>sublime</td>
<td>find all comedy movies with the regex query "genres ._Comedy._"</td>
<td>X</td>
</tr>
<tr><td>finder</td>
<td>open and browse</td>
<td>3 minutes</td>
</tr>
<tr><td>git</td>
<td>init git for the treebase</td>
<td>nearInstant</td>
</tr>
<tr><td>git</td>
<td>see git status</td>
<td>6s</td>
</tr>
<tr><td>git</td>
<td>first git add for the treebase</td>
<td>40 minutes</td>
</tr>
<tr><td>git</td>
<td>first git commit</td>
<td>10 minutes</td>
</tr>
<tr><td>sublime</td>
<td>edit some file</td>
<td>X</td>
</tr>
<tr><td>git</td>
<td>git status when there is a change</td>
<td>instant</td>
</tr>
<tr><td>git</td>
<td>add the change above</td>
<td>instant</td>
</tr>
<tr><td>git</td>
<td>commit the change</td>
<td>instant</td>
</tr>
<tr><td>github</td>
<td>push the treebase to github</td>
<td>~10 seconds</td>
</tr>
<tr><td>treebase</td>
<td>how long will it take to start treebase</td>
<td>~10 seconds</td>
</tr>
<tr><td>treebase</td>
<td>how long will it take to scan the base for errors.</td>
<td>~5 seconds</td>
</tr></tbody>
 </table>
<p id="particle292" class="scrollParagraph">ðŸ’£ <code class="scrollInlineCode">ls</code> is now nearly unusable. <code class="scrollInlineCode">ls -f -1 -U</code> takes about 30 seconds. A straight up <code class="scrollInlineCode">ls</code> takes about 45s.</p>
<p id="particle294" class="scrollParagraph">ðŸ’£ Sublime Text failed to open. After 10 minutes of 100% CPU usage and <a href="https://en.wikipedia.org/wiki/Spinning_pinwheel">beachball'ing</a> I force quit the program. I tried twice to be sure with the same result.</p>
<p id="particle296" class="scrollParagraph">ðŸ’£ <code class="scrollInlineCode">mdworker_shared</code> again kept my laptop running hot. I found a way of potentially <a href="http://osxdaily.com/2011/12/30/exclude-drives-or-folders-from-spotlight-index-mac-os-x/">disabling Mac OS X Spotlight Indexing</a> of the IMDB folder.</p>
<p id="particle298" class="scrollParagraph">ðŸ’£ Opening the <code class="scrollInlineCode">600k</code> folder in Apple's Finder gave me a loading screen for about 3 minutes</p>
<figure class="scrollCaptionedFigure" style="width:530px; margin: auto;"><a href="600k-finder-loading.png" target="_blank"  ><img src="600k-finder-loading.png" width="530" height="647" loading="lazy"></a></figure>
<p id="particle302" class="scrollParagraph">At least it eventually came up:</p>
<figure class="scrollCaptionedFigure" style="width:547px; margin: auto;"><a href="600k-finder.png" target="_blank"  ><img src="600k-finder.png" width="547" height="592" loading="lazy"></a></figure>
<p id="particle306" class="scrollParagraph">Now, how about Git?</p>
<p id="particle308" class="scrollParagraph">ðŸ’£ The first <code class="scrollInlineCode">git add .</code> took <em>40 minutes</em>! Yikes.</p>
<code class="scrollCodeBlock">real  39m30.215s
user  1m19.968s
sys 13m49.157s</code>
<p id="particle312" class="scrollParagraph">ðŸ’£ <code class="scrollInlineCode">git status</code> after the initial git add took about a minute.</p>
<p id="particle314" class="scrollParagraph">ðŸ’£ The first <code class="scrollInlineCode">git commit</code> after the git add took about 10 minutes.</p>
<p id="particle316" class="scrollParagraph">GitHub turns out to be a real champ. Even with 600k files the first <code class="scrollInlineCode">git push</code> took less than 30 seconds.</p>
<code class="scrollCodeBlock">real  0m22.406s
user  0m2.657s
sys 0m1.724s</code>
<p id="particle320" class="scrollParagraph">The <a href="https://github.com/breck7/600k">600k repo</a> on GitHub comes up near instantly. GitHub just shows the first 1k out of 600k files which I think is a good compromise, and far better than a multiple minute loading screen.</p>
<p id="particle322" class="scrollParagraph">ðŸ’£ Sadly there doesn't seem to be any pagination for this situation on GitHub, so not sure how to view the rest of the directory contents.</p>
<p id="particle324" class="scrollParagraph">I can pull up a file quickly on GitHub, like the entry for <a href="https://github.com/breck7/600k/blob/master/007-licence-to-kill.title">License to Kill</a>.</p>
<p id="particle326" class="scrollParagraph">How about editing files locally? Sublime is no use so I'll use <code class="scrollInlineCode">vim</code>. Because <code class="scrollInlineCode">ls</code> is so slow, I'll find the file I want to edit on GitHub. Of course because I can't find pagination in GitHub I'll be limited to editing one of the first 1k files. I'll use just that License to Kill entry.</p>
<p id="particle328" class="scrollParagraph">So the command I use <code class="scrollInlineCode">vim 007-licence-to-kill.title</code>. Editing that file is simple enough. Though I wish we had support for Tree Notation in vim to get syntax highlighting and such.</p>
<p id="particle330" class="scrollParagraph">ðŸ’£ Now I do <code class="scrollInlineCode">git add .</code>. Again this takes a while. What I now realize is that my fancy command prompt does some <code class="scrollInlineCode">git status</code> with every command. So let's disable that.</p>
<p id="particle332" class="scrollParagraph">After going in and cleaning up my shell (including switching to zsh) I've got a bit more performance back on the command line.</p>
<p id="particle334" class="scrollParagraph">ðŸ’£ But just a bit. A <code class="scrollInlineCode">git status</code> still takes about 23 seconds! Even with the <code class="scrollInlineCode">-uno</code> option it takes about 15 seconds. This is with 1 modified file.</p>
<p id="particle336" class="scrollParagraph">Now adding this 1 file seems tricky. Most of the time I do a <code class="scrollInlineCode">git status</code> and see that I want to add everything so I do a <code class="scrollInlineCode">git add .</code>.</p>
<p id="particle338" class="scrollParagraph">ðŸ’£ But I tried <code class="scrollInlineCode">git add .</code> in the 600k TreeBase and after 100 seconds I killed the job. Instead I resorted to <code class="scrollInlineCode">git add 007-licence-to-kill.title</code> which worked pretty much instantly.</p>
<p id="particle340" class="scrollParagraph">ðŸ’£ <code class="scrollInlineCode">git commit</code> for this 1 change took about 20 seconds. Not too bad but much worse than normal.</p>
<p id="particle342" class="scrollParagraph"><code class="scrollInlineCode">git push</code> was just a few seconds.</p>
<p id="particle344" class="scrollParagraph">I was able to <a href="https://github.com/breck7/600k/blob/master/007-licence-to-kill.title">see the change on GitHub</a> instantly. Editing that file on GitHub and committing was a breeze. Looking at the change history and blame on GitHub was near instant.</p>
<p id="particle346" class="scrollParagraph">Git blame locally was also just a couple of seconds.</p>
<div class="scrollSection"><h1 id="particle348" class="scrollParagraph">Pause to Reflect</h1>
</div>
<p id="particle350" class="scrollParagraph">So TreeBase struggles at the 600k level. You cannot just use TreeBase at the 100k level without preparing your system for it. Issues arise with GUIs like Finder and Sublime, background file system processes, shells, git, basic bash utilities, and so forth.</p>
<p id="particle352" class="scrollParagraph">I haven't looked yet into RAM based file systems or how to setup my system to make this use case work well, but for now, out of the box, I cannot recommend TreeBase for databases of more than 100,000 entities.</p>
<p id="particle354" class="scrollParagraph">Is there even a point now to try 6.5M? Arguably no.</p>
<p id="particle356" class="scrollParagraph">However, I've come this far! No turning back now.</p>
<div class="scrollSection"><h1 id="particle358" class="scrollParagraph">A 6.5M TreeBase</h1>
</div>
<p id="particle360" class="scrollParagraph">To recap what I am doing here: I am taking a single 6.5 million row 500MB TSV file that could easily be parsed into a SQLite or other battle hardened database and instead turning it into a monstrous 6.5 million file TreeBase backed by Git and writing it to my hard disk with no special configuration.</p>
<p id="particle362" class="scrollParagraph">By the way, I forgot to mention my system specs for the record. I'm doing this on a MacBook Air running macOS Catalina on a 2.2Ghz Dual-core i7 with 8GB of 1600 Mhz DDR3 Ram with a 500GB Apple SSD using APFS. This is the last MacBook with a great keyboard, so I really hope it doesn't break.</p>
<p id="particle364" class="scrollParagraph">Okay, back to the task at hand.</p>
<p id="particle366" class="scrollParagraph">I need to generate the 6.5M files in a single directory. The 600k TreeBase took 6 minutes to generate so if that scales linearly 6.5M should take an hour. The first <code class="scrollInlineCode">git add</code> for 600k took 40 minutes, so that for 6.5M could take 6 hours. The first <code class="scrollInlineCode">git commit</code> for 600k took 10 minutes, so potentially 1.5 hours for 6.5M. So this little operation might take about 10 hours.</p>
<p id="particle368" class="scrollParagraph">I'll stitch these operations together into a shell script and run it overnight (I'll make sure to check the batteries in my smoke detectors first).</p>
<p id="particle370" class="scrollParagraph">Here's the script to run the whole routine:</p>
<code class="scrollCodeBlock">time node buildStream.js
time cd ~/imdb/6m/
time git add .
time git commit -m "initial commit"
time git push</code>
<p id="particle374" class="scrollParagraph">Whenever running a long script, it's smart to test it with a smaller dataset first. I successfully tested this script with the 6k file dataset. Everything worked. Everything should be all set for the final test.</p>
<p id="particle376" class="scrollParagraph">(Later the next day...)</p>
<div class="scrollSection"><h1 id="particle378" class="scrollParagraph">It's Alive!</h1>
</div>
<p id="particle380" class="scrollParagraph">It worked!!! I now have a TreeBase with over 6 million files in a single directory. Well, a few things worked, most things did not.</p>
<table id="table65" class="scrollTable">
 <thead><tr><th>category</th>

<th>description</th>

<th>result</th>
</tr></thead>
 <tbody><tr><td>bash</td>
<td>ls</td>
<td>X</td>
</tr>
<tr><td>sublime</td>
<td>Start sublime in the TreeBase folder</td>
<td>X</td>
</tr>
<tr><td>sublime</td>
<td>scroll and click around files in the treebase folder and see how responsive it feels.</td>
<td>X</td>
</tr>
<tr><td>sublime</td>
<td>find all movies with the query "titleType movie"</td>
<td>X</td>
</tr>
<tr><td>sublime</td>
<td>find all comedy movies with the regex query "genres ._Comedy._"</td>
<td>X</td>
</tr>
<tr><td>finder</td>
<td>open and browse</td>
<td>X</td>
</tr>
<tr><td>git</td>
<td>init git for the treebase</td>
<td>nearInstant</td>
</tr>
<tr><td>git</td>
<td>first git add for the treebase</td>
<td>12 hours</td>
</tr>
<tr><td>git</td>
<td>first git commit</td>
<td>5 hours</td>
</tr>
<tr><td>sublime</td>
<td>edit some file</td>
<td>X</td>
</tr>
<tr><td>git</td>
<td>git status when there is a change</td>
<td>X</td>
</tr>
<tr><td>git</td>
<td>add the change above</td>
<td>X</td>
</tr>
<tr><td>git</td>
<td>commit the change</td>
<td>X</td>
</tr>
<tr><td>github</td>
<td>push the treebase to github</td>
<td>X</td>
</tr>
<tr><td>treebase</td>
<td>how long will it take to start treebase</td>
<td>X</td>
</tr>
<tr><td>treebase</td>
<td>how long will it take to scan the base for errors.</td>
<td>X</td>
</tr></tbody>
 </table>
<p id="particle384" class="scrollParagraph">ðŸ’£ There was a slight hiccup in my script where somehow v8 again ran out of memory. But only after creating 6,340,000 files, which is good enough for my purposes.</p>
<p id="particle386" class="scrollParagraph">ðŸ’£ But boy was this slow! The creation of the 6M+ files took 3 hours and 20 minutes.</p>
<p id="particle388" class="scrollParagraph">ðŸ’£  The first <code class="scrollInlineCode">git add .</code> took a whopping 12 hours!</p>
<p id="particle390" class="scrollParagraph">ðŸ’£ The first <code class="scrollInlineCode">git commit</code> took 5 hours!</p>
<p id="particle392" class="scrollParagraph">ðŸ’£ A few times when I checked on the machine it was running hot. Not sure if from CPU or Disk or a combination.</p>
<p id="particle394" class="scrollParagraph">ðŸ’£ I eventually quit <code class="scrollInlineCode">git push</code>. It quickly completed <code class="scrollInlineCode">Counting objects: 6350437, done.</code> but then nothing happened except lots of CPU usage for hours.</p>
<p id="particle396" class="scrollParagraph">Although most programs failed, I was at least able to successfully create this monstrosity and navigate the folder.</p>
<p id="particle398" class="scrollParagraph">The experiment has completed. I took a perfectly usable 6.5M row TSV file and transformed it into a beast that brings some of the most well-known programs out there to their knees.</p>
<p id="particle400" class="scrollParagraph">ðŸ’£ NOTE: I do not recommend trying this at home. My laptop became lava hot at points. Who knows what wear and tear I added to my hard disk.</p>
<div class="scrollSection"><h4 id="particle402" class="scrollQuestion">What have I learned?</h4>
</div>
<p id="particle404" class="scrollParagraph">So that is the end of the experiment. Can you build a Git-backed TreeBase with 6.5M files in a single folder? Yes. Should you? No. Most of your tools won't work or will be far too slow. There's infrastructure and design work to be done.</p>
<p id="particle406" class="scrollParagraph">I was actually pleasantly surprised by the results of this early test. I was confident it was going to fail but I wasn't sure exactly how it would fail and at what scale. Now I have a better idea of that. TreeBase currently sucks at the 100k level.</p>
<p id="particle408" class="scrollParagraph">I also now know that the hardware for this type of system feels ready and it's just parts of some software systems that need to be adapted to handle folders with lots of files. I think those software improvements across the stack will be made and this dumb thing could indeed scale.</p>
<div class="scrollSection"><h4 id="particle410" class="scrollQuestion">What's Next?</h4>
</div>
<p id="particle412" class="scrollParagraph">Now, my focus at the moment is not on big TreeBases. My focus is on making the experience of working with little TreeBases great. I want to help get things like <a href="https://github.com/treenotation/jtree/issues/2">Language Server Protocol</a> going for TreeBases and a Content Management System backed by TreeBase.</p>
<p id="particle414" class="scrollParagraph">But I now can envision how, once the tiny TreeBase experience is nailed, you should be able to use this for bigger tasks. The infrastructure is there to make it feasible with just a few adjustments. There are some config tweaks that can be made, more in-memory approaches, and some straightforward algorithmic additions to make to a few pieces of software. I also have had some fun conversations where people have suggested good sharding strategies that may prove useful without changing the simplicity of the system.</p>
<p id="particle416" class="scrollParagraph">That being said, it would be fun to do this experiment again but this time try and make it work. Once that's a success, it would be fun to try and scale it another 100x, and try to build a TreeBase for something like the 180M paper <a href="https://www.semanticscholar.org/">Semantic Scholar</a> dataset.</p>
<div class="scrollSection"><h4 id="particle418" class="scrollQuestion">Why Oh Why TreeBase?</h4>
</div>
<p id="particle420" class="scrollParagraph">Okay, you might be wondering what is the point of this system? Specifically, why use the file system and why use Tree Notation?</p>
<div class="scrollSection"><h1 id="particle422" class="scrollParagraph">1) The File System is Going to Be Here for a Long Long Time</h1>
</div>
<p id="particle424" class="scrollParagraph">1) About 30m programmers use approximately 100 to 500 general purpose programming languages. All of these actively used general purpose languages have battle tested APIs for interacting with file systems. They don't all have interfaces to every database program. Any programmer, no matter what language they use, without having to learn a new protocol, language, or package, could write code to interact with a TreeBase using knowledge they already have. Almost every programmer uses Git now as well, so they'd be familiar with how TreeBase change control works.</p>
<p id="particle426" class="scrollParagraph">2) Over one billion more casual users are familiar with using their operating system tools for interacting with Files (like Explorer and Finder). Wouldn't it be cool if they could use tools they already know to interact with structured data?</p>
<p id="particle428" class="scrollParagraph">Wouldn't it be cool if we could combine sophisticated type checking, querying, and analytical capabilities of databases with the simplicity of files? Programmers can easily build GUIs on top of TreeBase that have any and all of the functionality of traditional database-backed programs but have the additional advantage of an extremely well-known access vector to their information.</p>
<p id="particle430" class="scrollParagraph">People have been predicting the death of files but these predictions are wrong. Even Apple recently backtracked and added a Files interface to iOS. Files and folders aren't going anywhere. It's a very simple and useful design pattern that works in the analog and digital realm. Files have been around for <a href="https://en.wikipedia.org/wiki/Papyrus">at least 4,500 years</a> and my guess is will be around for another 5,000 years, if the earth doesn't blow up. Instead of dying, on the contrary file systems will keep getting better and better.</p>
<div class="scrollSection"><h1 id="particle432" class="scrollParagraph">2) Tree Notation is All You Need to Create Meaningful Semantic Content</h1>
</div>
<p id="particle434" class="scrollParagraph">People have recognized the value of semantic, strongly typed content for a long time. Databases have been strongly typed since the beginning of databases. Strongly typed programming languages have dominated the software world since the beginning of software.</p>
<p id="particle436" class="scrollParagraph">People have been attempting to build a system for collaborative semantic content for decades. <a href="https://en.wikipedia.org/wiki/XML">XML</a>, <a href="https://www.w3.org/RDF/">RDF</a>, <a href="https://www.w3.org/TR/owl2-overview/">OWL2</a>, <a href="https://json-ld.org/">JSON-LD</a>, <a href="http://schema.org/">Schema.org</a>â€”these are all great projects. I just think they can be simplified and I think one strong refinement is Tree Notation.</p>
<p id="particle438" class="scrollParagraph">I imagine a world where you can effortlessly pass TreeBases around and combine them in interesting ways. As a kid I used to collect baseball cards. I think it would be cool if you could just as easily pass around "cards" like a "TreeBase of all the World's Medicines" or a "TreeBase of all the world's academic papers" or a "TreeBase of all the world's chemical compounds" and because I know how to work with one TreeBase I could get value out of any of these TreeBases. Unlike books or weakly typed content like Wikipedia, TreeBases are computable. They are like specialized little brains that you can build smart things out of.</p>
<p id="particle440" class="scrollParagraph">So I think this could be pretty cool. As dumb as it is.</p>
<p id="particle442" class="scrollParagraph">I would love to hear your thoughts.</p>
<div class="scrollKeyboardNav" style="display:none;"><a href="integrity-and-perseverance-in-business-ensure-success.html">integrity-and-perseverance-in-business-ensure-success.html</a> Â· building-a-treebase-with-6.5-million-files.html Â· <a href="dataset-needed.html">dataset-needed.html</a><script>document.addEventListener('keydown', function(event) {
  if (document.activeElement !== document.body) return
  if (event.altKey || event.ctrlKey || event.metaKey || event.shiftKey) return // dont interfere with keyboard back button shortcut
  const getLinks = () => document.getElementsByClassName("scrollKeyboardNav")[0].getElementsByTagName("a")
  if (event.key === "ArrowLeft")
    getLinks()[0].click()
  else if (event.key === "ArrowRight")
    getLinks()[1].click()
 });</script></div>
</div>
</div>
<br>
<center><p id="particle455" class="scrollParagraph"></p>
<style>.abstractIconButtonParser {position:absolute;top:0.25rem; }.abstractIconButtonParser svg {fill: rgba(204,204,204,.8);width:1.875rem;height:1.875rem; padding: 0 7px;} .abstractIconButtonParser:hover svg{fill: #333;}</style><a href="https://wws.scroll.pub" class="doNotPrint abstractIconButtonParser" style="position:relative;"><svg xmlns="http://www.w3.org/2000/svg" direction="ltr" width="231.52568231268793" height="249.33156169975996" viewBox="297.27169239534896 1273.121785992385 231.52568231268793 249.33156169975996" stroke-linecap="round" stroke-linejoin="round" data-color-mode="dark" class="tl-container tl-theme__force-sRGB tl-theme__dark" ><defs/><g transform="matrix(1, 0, 0, 1, 395.9682, 1413.3618)" opacity="1"><g transform="scale(1)"><path d="M-5.7342,-1.1484 T-5.0182,-4.6536 -2.6672,-12.9768 1.7374,-22.3903 8.4597,-30.0892 16.5455,-35.2796 25.3478,-37.8247 34.4641,-37.2199 43.0676,-33.4606 50.27,-27.1118 55.7861,-19.7972 59.8042,-11.6764 61.6844,-2.3157 60.8049,7.9615 57.3259,17.5954 51.2605,25.5515 41.9451,31.9237 30.6489,36.2084 18.9812,37.6038 8.4915,36.637 -1.3063,34.5174 -10.6869,31.6604 -19.0463,27.0252 -26.0612,20.1562 -31.864,11.1271 -35.2772,1.0066 -35.7963,-9.1933 -35.203,-19.2337 -32.52,-28.3259 -27.3388,-37.4245 -20.2857,-45.7085 -11.787,-53.0395 -2.4314,-58.4864 7.1724,-61.8739 17.5002,-65.6025 28.2859,-68.1034 38.514,-69.1081 48.1844,-69.9134 57.9136,-70.1787 67.4056,-69.5971 76.297,-67.7446 84.5233,-63.97 92.0158,-57.5003 98.1976,-48.5614 102.8839,-38.056 105.9936,-27.6097 107.074,-18.168 107.175,-8.2882 106.6452,1.9768 105.4734,11.7698 104.0279,21.1013 101.7439,31.0445 98.0977,40.6386 92.7822,49.1039 86.2847,57.2337 78.6099,64.7113 69.8339,70.974 61.2863,75.092 52.4283,78.2186 42.5338,80.7945 32.7733,82.6629 22.8568,83.6574 12.2803,83.3538 2.4971,81.4828 -6.3367,78.789 -15.1061,75.8011 -24.259,72.3779 -33.2286,68.991 -41.5707,64.8363 -49.153,59.1909 -55.8375,52.2938 -62.9311,43.9553 -68.4604,34.4882 -71.2761,23.5855 -72.748,12.7452 -73.7673,2.0453 -74.1187,-8.7386 -72.293,-19.3856 -68.7376,-30.4053 -64.12,-39.7852 -59.1825,-47.8931 -53.7695,-56.4512 -48.1998,-65.7676 -43.1389,-74.401 -36.9006,-81.0179 -28.4317,-86.2639 -18.3342,-90.3521 -8.9259,-93.9355 0.1927,-98.7179 9.3551,-103.3537 18.7651,-106.7552 29.7482,-110.3584 40.9287,-113.446 50.87,-115.2231 57.8279,-116.0074 60.4065,-116.0632 A7.8326,7.8326 0 0 1 61.1735,-100.4168 T58.6018,-100.2201 51.1634,-99.3008 41.695,-96.884 32.4044,-94.0187 22.65,-91.382 13.4974,-87.3756 5.0519,-83.1026 -5.0443,-78.6175 -15.7236,-74.4743 -24.6193,-70.2681 -31.274,-62.5903 -36.3827,-53.9362 -41.2833,-46.2905 -46.0679,-38.5161 -50.639,-30.6576 -54.6876,-22.4063 -57.6038,-12.3346 -58.5104,-1.8678 -57.6022,9.4969 -56.0628,20.477 -53.6434,29.0487 -48.8908,36.7517 -42.4075,43.9784 -35.3064,50.6236 -27.3553,55.2062 -17.6884,59.4064 -7.6442,63.6638 2.4427,67.0449 12.7308,69.4843 22.9294,70.2171 33.2547,69.3921 42.4972,67.7384 52.2753,64.8425 61.8649,60.9142 69.5292,56.0828 76.3604,49.5927 82.431,42.3194 87.219,34.619 90.6076,25.5217 92.547,16.0352 93.8703,7.1315 94.4972,-2.5268 94.3672,-13.3681 93.3204,-24.4252 90.5377,-34.1656 85.7321,-43.6441 78.7334,-51.8057 68.7542,-56.0559 57.9857,-57.2713 48.079,-57.0198 38.4535,-56.3204 28.5246,-55.0036 18.6104,-52.4796 9.6402,-49.559 0.7193,-46.2981 -7.1531,-41.3715 -13.708,-34.8957 -19.5435,-26.853 -22.8356,-17.0622 -23.363,-6.5446 -21.9969,3.1439 -17.1086,11.9113 -9.276,18.744 -0.0685,22.6058 9.3636,24.796 19.2422,25.8817 29.052,25.0411 37.9338,21.3502 45.6819,13.8498 49.6675,4.5228 49.2802,-5.1854 45.3277,-14.4455 38.8603,-21.7879 30.5488,-25.7753 21.3356,-24.3975 13.6687,-19.2391 8.8217,-10.9919 6.423,-2.3609 5.7342,1.1484 A5.8481,5.8481 0 0 1 -5.7342,-1.1484 Z" stroke-linecap="round"/></g></g></svg></a>
<style>.abstractIconButtonParser {position:absolute;top:0.25rem; }.abstractIconButtonParser svg {fill: rgba(204,204,204,.8);width:1.875rem;height:1.875rem; padding: 0 7px;} .abstractIconButtonParser:hover svg{fill: #333;}</style><a href="mailto:breck7@gmail.com" class="doNotPrint abstractIconButtonParser" style="position:relative;"><svg viewBox="3 5 24 20" width="24" height="20" xmlns="http://www.w3.org/2000/svg"><g transform="matrix(1, 0, 0, 1, 0, -289.0625)"><path style="opacity:1;stroke:none;stroke-width:0.49999997;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1" d="M 5 5 C 4.2955948 5 3.6803238 5.3628126 3.3242188 5.9101562 L 14.292969 16.878906 C 14.696939 17.282876 15.303061 17.282876 15.707031 16.878906 L 26.675781 5.9101562 C 26.319676 5.3628126 25.704405 5 25 5 L 5 5 z M 3 8.4140625 L 3 23 C 3 24.108 3.892 25 5 25 L 25 25 C 26.108 25 27 24.108 27 23 L 27 8.4140625 L 17.121094 18.292969 C 15.958108 19.455959 14.041892 19.455959 12.878906 18.292969 L 3 8.4140625 z " transform="translate(0,289.0625)" id="rect4592"/></g></svg></a>
<style>.abstractIconButtonParser {position:absolute;top:0.25rem; }.abstractIconButtonParser svg {fill: rgba(204,204,204,.8);width:1.875rem;height:1.875rem; padding: 0 7px;} .abstractIconButtonParser:hover svg{fill: #333;}</style><a href="edit.html?fileName=/building-a-treebase-with-6-point-5-million-files.scroll" class="doNotPrint abstractIconButtonParser" style="position:relative;"><svg width="800px" height="800px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M21.1213 2.70705C19.9497 1.53548 18.0503 1.53547 16.8787 2.70705L15.1989 4.38685L7.29289 12.2928C7.16473 12.421 7.07382 12.5816 7.02986 12.7574L6.02986 16.7574C5.94466 17.0982 6.04451 17.4587 6.29289 17.707C6.54127 17.9554 6.90176 18.0553 7.24254 17.9701L11.2425 16.9701C11.4184 16.9261 11.5789 16.8352 11.7071 16.707L19.5556 8.85857L21.2929 7.12126C22.4645 5.94969 22.4645 4.05019 21.2929 2.87862L21.1213 2.70705ZM18.2929 4.12126C18.6834 3.73074 19.3166 3.73074 19.7071 4.12126L19.8787 4.29283C20.2692 4.68336 20.2692 5.31653 19.8787 5.70705L18.8622 6.72357L17.3068 5.10738L18.2929 4.12126ZM15.8923 6.52185L17.4477 8.13804L10.4888 15.097L8.37437 15.6256L8.90296 13.5112L15.8923 6.52185ZM4 7.99994C4 7.44766 4.44772 6.99994 5 6.99994H10C10.5523 6.99994 11 6.55223 11 5.99994C11 5.44766 10.5523 4.99994 10 4.99994H5C3.34315 4.99994 2 6.34309 2 7.99994V18.9999C2 20.6568 3.34315 21.9999 5 21.9999H16C17.6569 21.9999 19 20.6568 19 18.9999V13.9999C19 13.4477 18.5523 12.9999 18 12.9999C17.4477 12.9999 17 13.4477 17 13.9999V18.9999C17 19.5522 16.5523 19.9999 16 19.9999H5C4.44772 19.9999 4 19.5522 4 18.9999V7.99994Z"/></svg></a>
<br><br>
<div class="abstractTextLinkParser"><a href="https://scroll.pub">Built with Scroll v178.1.0</a></div>
</center>
</body>
</html>